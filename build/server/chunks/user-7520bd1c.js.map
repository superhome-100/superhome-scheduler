{"version":3,"file":"user-7520bd1c.js","sources":["../../../.svelte-kit/adapter-node/chunks/user.js"],"sourcesContent":["import { g as getXataClient } from \"./xata-old.js\";\nconst xata = getXataClient();\nasync function getAllUsers() {\n  const users = await xata.db.Users.getAll();\n  return users;\n}\nasync function addUser({\n  firebaseUID,\n  providerId,\n  providerUserId,\n  email,\n  userName\n}) {\n  const record = await xata.db.Users.create({\n    [providerId === \"facebook.com\" ? \"facebookId\" : \"googleId\"]: providerUserId,\n    name: userName,\n    nickname: userName,\n    status: \"disabled\",\n    email: email || null,\n    firebaseUID\n  });\n  await xata.db.UserPriceTemplates.create({ user: record.id, priceTemplate: \"regular\" });\n  return record;\n}\nasync function updateUserEmailAndFirebaseUID(userId, email, firebaseUID) {\n  const record = await xata.db.Users.update(userId, { email, firebaseUID });\n  return record;\n}\nasync function updateNickname(userId, nickname) {\n  const record = await xata.db.Users.update(userId, { nickname });\n  return record;\n}\nasync function getUsersById(ids) {\n  return await xata.db.Users.read(ids);\n}\nasync function authenticateUser(data) {\n  let userRecord;\n  const isFacebook = data.providerId === \"facebook.com\";\n  const email = data.email.trim().toLowerCase();\n  const overwriteEmail = !isFacebook && data.userRecordId;\n  if (overwriteEmail) {\n    console.log(\"doing overwrite email\", data.userRecordId, email, data.firebaseUID);\n    const oldUserRecord = await xata.db.Users.read(data.userRecordId);\n    if (oldUserRecord && oldUserRecord.email !== email) {\n      await updateUserEmailAndFirebaseUID(data.userRecordId, email, data.firebaseUID);\n    }\n    userRecord = oldUserRecord;\n  } else {\n    const [providerMatch, emailMatch] = await Promise.all([\n      isFacebook ? xata.db.Users.filter({ facebookId: data.userId }).getFirst() : xata.db.Users.filter({ googleId: data.userId }).getFirst(),\n      email ? xata.db.Users.filter({ email }).getFirst() : null\n    ]);\n    if (!providerMatch && !emailMatch) {\n      userRecord = await addUser({\n        firebaseUID: data.firebaseUID,\n        providerId: data.providerId,\n        providerUserId: data.userId,\n        email,\n        userName: data.userName\n      });\n    } else if (!emailMatch && providerMatch) {\n      if (!isFacebook) {\n        await updateUserEmailAndFirebaseUID(providerMatch.id, email, data.firebaseUID);\n      }\n      userRecord = providerMatch;\n    } else {\n      userRecord = emailMatch || providerMatch;\n    }\n  }\n  return userRecord;\n}\nasync function getUserByEmail(email) {\n  const users = await xata.db.Users.filter({ email }).getAll();\n  let user = users[0];\n  if (users.length > 1) {\n    user = users.find((u) => u.status === \"active\") || users[0];\n  }\n  return user;\n}\nasync function getUserByFirebaseUID(firebaseUID) {\n  const users = await xata.db.Users.filter({ firebaseUID }).getAll();\n  users[0];\n  if (users.length > 1) {\n    users.find((u) => u.status === \"active\") || users[0];\n  }\n  return users[0];\n}\nasync function getUserByFacebookId(facebookId) {\n  const user = await xata.db.Users.filter({ facebookId }).getFirst();\n  return user;\n}\nasync function getUserByCookies(cookies) {\n  const sessionID = cookies.get(\"sessionid\");\n  if (!sessionID)\n    return void 0;\n  let record = await xata.db.Sessions.read(sessionID);\n  if (record == void 0) {\n    return void 0;\n  }\n  return await xata.db.Users.read(record.user);\n}\nexport {\n  authenticateUser as a,\n  getUserByCookies as b,\n  getUsersById as c,\n  getUserByEmail as d,\n  getUserByFirebaseUID as e,\n  getUserByFacebookId as f,\n  getAllUsers as g,\n  updateNickname as u\n};\n"],"names":[],"mappings":";;AACA,MAAM,IAAI,GAAG,aAAa,EAAE,CAAC;AAC7B,eAAe,WAAW,GAAG;AAC7B,EAAE,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,EAAE,CAAC;AAC7C,EAAE,OAAO,KAAK,CAAC;AACf,CAAC;AACD,eAAe,OAAO,CAAC;AACvB,EAAE,WAAW;AACb,EAAE,UAAU;AACZ,EAAE,cAAc;AAChB,EAAE,KAAK;AACP,EAAE,QAAQ;AACV,CAAC,EAAE;AACH,EAAE,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC;AAC5C,IAAI,CAAC,UAAU,KAAK,cAAc,GAAG,YAAY,GAAG,UAAU,GAAG,cAAc;AAC/E,IAAI,IAAI,EAAE,QAAQ;AAClB,IAAI,QAAQ,EAAE,QAAQ;AACtB,IAAI,MAAM,EAAE,UAAU;AACtB,IAAI,KAAK,EAAE,KAAK,IAAI,IAAI;AACxB,IAAI,WAAW;AACf,GAAG,CAAC,CAAC;AACL,EAAE,MAAM,IAAI,CAAC,EAAE,CAAC,kBAAkB,CAAC,MAAM,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,EAAE,EAAE,aAAa,EAAE,SAAS,EAAE,CAAC,CAAC;AACzF,EAAE,OAAO,MAAM,CAAC;AAChB,CAAC;AACD,eAAe,6BAA6B,CAAC,MAAM,EAAE,KAAK,EAAE,WAAW,EAAE;AACzE,EAAE,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,EAAE,EAAE,KAAK,EAAE,WAAW,EAAE,CAAC,CAAC;AAC5E,EAAE,OAAO,MAAM,CAAC;AAChB,CAAC;AACD,eAAe,cAAc,CAAC,MAAM,EAAE,QAAQ,EAAE;AAChD,EAAE,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,MAAM,EAAE,EAAE,QAAQ,EAAE,CAAC,CAAC;AAClE,EAAE,OAAO,MAAM,CAAC;AAChB,CAAC;AACD,eAAe,YAAY,CAAC,GAAG,EAAE;AACjC,EAAE,OAAO,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;AACvC,CAAC;AACD,eAAe,gBAAgB,CAAC,IAAI,EAAE;AACtC,EAAE,IAAI,UAAU,CAAC;AACjB,EAAE,MAAM,UAAU,GAAG,IAAI,CAAC,UAAU,KAAK,cAAc,CAAC;AACxD,EAAE,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC;AAChD,EAAE,MAAM,cAAc,GAAG,CAAC,UAAU,IAAI,IAAI,CAAC,YAAY,CAAC;AAC1D,EAAE,IAAI,cAAc,EAAE;AACtB,IAAI,OAAO,CAAC,GAAG,CAAC,uBAAuB,EAAE,IAAI,CAAC,YAAY,EAAE,KAAK,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;AACrF,IAAI,MAAM,aAAa,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;AACtE,IAAI,IAAI,aAAa,IAAI,aAAa,CAAC,KAAK,KAAK,KAAK,EAAE;AACxD,MAAM,MAAM,6BAA6B,CAAC,IAAI,CAAC,YAAY,EAAE,KAAK,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;AACtF,KAAK;AACL,IAAI,UAAU,GAAG,aAAa,CAAC;AAC/B,GAAG,MAAM;AACT,IAAI,MAAM,CAAC,aAAa,EAAE,UAAU,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;AAC1D,MAAM,UAAU,GAAG,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,UAAU,EAAE,IAAI,CAAC,MAAM,EAAE,CAAC,CAAC,QAAQ,EAAE,GAAG,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,QAAQ,EAAE,IAAI,CAAC,MAAM,EAAE,CAAC,CAAC,QAAQ,EAAE;AAC5I,MAAM,KAAK,GAAG,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC,QAAQ,EAAE,GAAG,IAAI;AAC/D,KAAK,CAAC,CAAC;AACP,IAAI,IAAI,CAAC,aAAa,IAAI,CAAC,UAAU,EAAE;AACvC,MAAM,UAAU,GAAG,MAAM,OAAO,CAAC;AACjC,QAAQ,WAAW,EAAE,IAAI,CAAC,WAAW;AACrC,QAAQ,UAAU,EAAE,IAAI,CAAC,UAAU;AACnC,QAAQ,cAAc,EAAE,IAAI,CAAC,MAAM;AACnC,QAAQ,KAAK;AACb,QAAQ,QAAQ,EAAE,IAAI,CAAC,QAAQ;AAC/B,OAAO,CAAC,CAAC;AACT,KAAK,MAAM,IAAI,CAAC,UAAU,IAAI,aAAa,EAAE;AAC7C,MAAM,IAAI,CAAC,UAAU,EAAE;AACvB,QAAQ,MAAM,6BAA6B,CAAC,aAAa,CAAC,EAAE,EAAE,KAAK,EAAE,IAAI,CAAC,WAAW,CAAC,CAAC;AACvF,OAAO;AACP,MAAM,UAAU,GAAG,aAAa,CAAC;AACjC,KAAK,MAAM;AACX,MAAM,UAAU,GAAG,UAAU,IAAI,aAAa,CAAC;AAC/C,KAAK;AACL,GAAG;AACH,EAAE,OAAO,UAAU,CAAC;AACpB,CAAC;AACD,eAAe,cAAc,CAAC,KAAK,EAAE;AACrC,EAAE,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,KAAK,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC;AAC/D,EAAE,IAAI,IAAI,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC;AACtB,EAAE,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE;AACxB,IAAI,IAAI,GAAG,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,MAAM,KAAK,QAAQ,CAAC,IAAI,KAAK,CAAC,CAAC,CAAC,CAAC;AAChE,GAAG;AACH,EAAE,OAAO,IAAI,CAAC;AACd,CAAC;AACD,eAAe,oBAAoB,CAAC,WAAW,EAAE;AACjD,EAAE,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,WAAW,EAAE,CAAC,CAAC,MAAM,EAAE,CAAC;AACrE,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC;AACX,EAAE,IAAI,KAAK,CAAC,MAAM,GAAG,CAAC,EAAE;AACxB,IAAI,KAAK,CAAC,IAAI,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,MAAM,KAAK,QAAQ,CAAC,IAAI,KAAK,CAAC,CAAC,CAAC,CAAC;AACzD,GAAG;AACH,EAAE,OAAO,KAAK,CAAC,CAAC,CAAC,CAAC;AAClB,CAAC;AACD,eAAe,mBAAmB,CAAC,UAAU,EAAE;AAC/C,EAAE,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE,UAAU,EAAE,CAAC,CAAC,QAAQ,EAAE,CAAC;AACrE,EAAE,OAAO,IAAI,CAAC;AACd,CAAC;AACD,eAAe,gBAAgB,CAAC,OAAO,EAAE;AACzC,EAAE,MAAM,SAAS,GAAG,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;AAC7C,EAAE,IAAI,CAAC,SAAS;AAChB,IAAI,OAAO,KAAK,CAAC,CAAC;AAClB,EAAE,IAAI,MAAM,GAAG,MAAM,IAAI,CAAC,EAAE,CAAC,QAAQ,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;AACtD,EAAE,IAAI,MAAM,IAAI,KAAK,CAAC,EAAE;AACxB,IAAI,OAAO,KAAK,CAAC,CAAC;AAClB,GAAG;AACH,EAAE,OAAO,MAAM,IAAI,CAAC,EAAE,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;AAC/C;;;;"}