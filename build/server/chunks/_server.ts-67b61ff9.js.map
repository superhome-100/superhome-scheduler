{"version":3,"file":"_server.ts-67b61ff9.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/facebook/deletion/_server.ts.js"],"sourcesContent":["import { j as json } from \"../../../../../chunks/index.js\";\nimport crypto from \"crypto\";\nimport { b as private_env } from \"../../../../../chunks/shared-server.js\";\nfunction base64UrlDecode(input) {\n  return Buffer.from(input.replace(/-/g, \"+\").replace(/_/g, \"/\"), \"base64\");\n}\nfunction parseSignedRequest(signedRequest, appSecret) {\n  const [encodedSig, payload] = signedRequest.split(\".\");\n  if (!encodedSig || !payload)\n    return null;\n  const sig = base64UrlDecode(encodedSig);\n  const dataJson = base64UrlDecode(payload).toString(\"utf8\");\n  const data = JSON.parse(dataJson);\n  if (!data.algorithm || String(data.algorithm).toUpperCase() !== \"HMAC-SHA256\") {\n    return null;\n  }\n  const expectedSig = crypto.createHmac(\"sha256\", appSecret).update(payload).digest();\n  if (!crypto.timingSafeEqual(sig, expectedSig)) {\n    return null;\n  }\n  return data;\n}\nasync function POST({ request, url }) {\n  try {\n    const appSecret = private_env.FACEBOOK_APP_SECRET;\n    if (!appSecret) {\n      console.error(\"FACEBOOK_APP_SECRET is not set\");\n      return json({ error: \"server_misconfigured\" }, { status: 500 });\n    }\n    let signed_request;\n    const contentType = request.headers.get(\"content-type\") || \"\";\n    if (contentType.includes(\"application/json\")) {\n      const body = await request.json();\n      signed_request = body?.signed_request;\n    } else if (contentType.includes(\"application/x-www-form-urlencoded\") || contentType.includes(\"multipart/form-data\")) {\n      const form = await request.formData();\n      signed_request = String(form.get(\"signed_request\") || \"\");\n    } else {\n      try {\n        const body = await request.json();\n        signed_request = body?.signed_request;\n      } catch {\n        const form = await request.formData();\n        signed_request = String(form.get(\"signed_request\") || \"\");\n      }\n    }\n    if (!signed_request) {\n      return json({ error: \"missing_signed_request\" }, { status: 400 });\n    }\n    const data = parseSignedRequest(signed_request, appSecret);\n    if (!data) {\n      return json({ error: \"invalid_signed_request\" }, { status: 400 });\n    }\n    const user_id = data.user_id;\n    console.log(\"Facebook data deletion requested for user_id:\", user_id);\n    const confirmation_code = crypto.randomBytes(8).toString(\"hex\");\n    const statusUrl = new URL(\"/facebook/data-deletion-status\", url);\n    statusUrl.searchParams.set(\"id\", confirmation_code);\n    return json({ url: statusUrl.toString(), confirmation_code });\n  } catch (err) {\n    console.error(\"Error handling FB data deletion callback:\", err);\n    return json({ error: \"internal_error\" }, { status: 500 });\n  }\n}\nexport {\n  POST\n};\n"],"names":[],"mappings":"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"}