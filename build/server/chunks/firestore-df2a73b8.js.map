{"version":3,"file":"firestore-df2a73b8.js","sources":["../../../.svelte-kit/adapter-node/chunks/firestore.js"],"sourcesContent":["import { F as FIREBASE_SERVICE_ACCOUNT_KEY, b as XATA_BRANCH } from \"./xata.codegen.js\";\nimport admin from \"firebase-admin\";\nimport { d as getUserByEmail, e as getUserByFirebaseUID, f as getUserByFacebookId } from \"./user.js\";\nimport dayjs from \"dayjs\";\nconst serviceAccount = JSON.parse(FIREBASE_SERVICE_ACCOUNT_KEY);\nif (!admin.apps.length) {\n  admin.initializeApp({\n    credential: admin.credential.cert(serviceAccount)\n  });\n}\nconst firestore = admin.firestore();\nasync function doTransaction(category, date, transaction) {\n  if ([\"pool\", \"classroom\"].includes(category)) {\n    const doc = firestore.collection(\"locks\").doc([category, XATA_BRANCH].join(\"_\"));\n    await firestore.runTransaction(async (t) => {\n      await t.get(doc);\n      await transaction();\n      await t.set(doc, {\n        updated_at: admin.firestore.FieldValue.serverTimestamp()\n      });\n    });\n  } else {\n    await transaction();\n  }\n  try {\n    const docName = `${category}_${date}_${XATA_BRANCH === \"main\" ? \"prod\" : \"dev\"}`;\n    const doc = firestore.collection(\"locks\").doc(docName);\n    await doc.set(\n      {\n        updated_at: admin.firestore.FieldValue.serverTimestamp()\n      },\n      { merge: true }\n    );\n  } catch (error) {\n    console.error(error);\n  }\n}\nasync function getXataUserDocWithFirebaseToken(headers) {\n  const authorizationHeader = headers.get(\"authorization\") || \"\";\n  const token = authorizationHeader.split(\"Bearer \")[1];\n  const decodedToken = await admin.auth().verifyIdToken(token);\n  const fbUser = await admin.auth().getUser(decodedToken.uid);\n  if (!fbUser)\n    throw new Error(\"firebase user not found!\");\n  let user;\n  if (fbUser.email) {\n    user = await getUserByEmail(fbUser.email);\n  }\n  if (!user && fbUser.uid) {\n    user = await getUserByFirebaseUID(fbUser.uid);\n  }\n  if (!user) {\n    const facebookId = fbUser.providerData.find((p) => p.providerId === \"facebook.com\")?.uid;\n    if (!facebookId)\n      throw new Error(\"facebookId not found!\");\n    user = await getUserByFacebookId(facebookId);\n  }\n  if (!user)\n    throw new Error(\"user not found!\");\n  return user;\n}\nasync function getDateSetting(date) {\n  const stage = process.env.PUBLIC_STAGE || \"prod\";\n  const docName = `date_settings_${stage}/${dayjs(date).format(\"YYYY-MM-DD\")}`;\n  return (await firestore.doc(docName).get()).data();\n}\nexport {\n  getDateSetting as a,\n  doTransaction as d,\n  getXataUserDocWithFirebaseToken as g\n};\n"],"names":[],"mappings":"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"}