{"version":3,"file":"_server-d2be80f7.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/updatePrices/_server.js"],"sourcesContent":["import { g as getXataClient } from \"../../../../chunks/xata-old.js\";\nimport { d as datetimeInPanglaoFromServer, a as datetimeToDateStr, t as timeStrToMin, f as firstOfMonthStr } from \"../../../../chunks/datetimeUtils.js\";\nimport { i as initSettings } from \"../../../../chunks/settings2.js\";\nconst xata = getXataClient();\nconst unpackTemplate = (uT) => {\n  return {\n    pool: {\n      course: uT.priceTemplate.coachPool,\n      autonomous: uT.priceTemplate.autoPool\n    },\n    classroom: {\n      course: uT.priceTemplate.coachClassroom\n    },\n    openwater: {\n      course: uT.priceTemplate.coachOW,\n      autonomous: uT.priceTemplate.autoOW,\n      cbs: uT.priceTemplate.cbsOW,\n      proSafety: uT.priceTemplate.proSafetyOW,\n      autonomousPlatform: uT.priceTemplate.platformOW,\n      autonomousPlatformCBS: uT.priceTemplate.platformCBSOW,\n      competitionSetupCBS: uT.priceTemplate[\"comp-setupOW\"]\n    }\n  };\n};\nasync function getOldAndNewRsvs(date) {\n  let reservations = await xata.db.Reservations.filter({\n    status: \"confirmed\",\n    date: { $le: date, $ge: firstOfMonthStr(date) }\n  }).getAll();\n  let oldRsvs = reservations.filter((rsv) => rsv.price != null);\n  let newRsvs = reservations.filter((rsv) => rsv.price == null);\n  return { oldRsvs, newRsvs };\n}\nasync function getTemplates(newRsvs) {\n  let uIds = Array.from(new Set(newRsvs.map((rsv) => rsv.user.id)));\n  let userTemplates = await xata.db.UserPriceTemplates.filter({ user: { $any: uIds } }).select([\"user\", \"priceTemplate\"]).getAll();\n  return userTemplates;\n}\nconst calcNAutoOW = (user, oldRsvs) => {\n  return oldRsvs.filter((rsv) => {\n    return rsv.user.id === user && rsv.resType === \"autonomous\" && rsv.category === \"openwater\";\n  }).length;\n};\nconst getStart = (rsv, amOWTime, pmOWTime) => {\n  return [\"pool\", \"classroom\"].includes(rsv.category) ? timeStrToMin(rsv.startTime) : rsv.category === \"openwater\" ? rsv.owTime === \"AM\" ? amOWTime : pmOWTime : void 0;\n};\nasync function GET() {\n  try {\n    const settings = await initSettings();\n    let d = datetimeInPanglaoFromServer();\n    let date = datetimeToDateStr(d);\n    let time = d.getHours() * 60 + d.getMinutes();\n    let maxChgbl = settings.getMaxChargeableOWPerMonth(date);\n    let amOWStart = timeStrToMin(settings.getOpenwaterAmStartTime(date));\n    let pmOWStart = timeStrToMin(settings.getOpenwaterPmStartTime(date));\n    let { oldRsvs, newRsvs } = await getOldAndNewRsvs(date);\n    if (newRsvs.length > 0) {\n      let updates = [];\n      let userTemplates = await getTemplates(newRsvs);\n      for (let uT of userTemplates) {\n        let tmp = unpackTemplate(uT);\n        let nAutoOW = calcNAutoOW(uT.user.id, oldRsvs);\n        let rsvs = newRsvs.filter((rsv) => rsv.user.id === uT.user.id);\n        for (let rsv of rsvs) {\n          let start = getStart(rsv, amOWStart, pmOWStart);\n          if (rsv.date < date || rsv.date === date && start <= time) {\n            let price;\n            if (rsv.category === \"openwater\" && rsv.resType === \"autonomous\") {\n              nAutoOW++;\n              if (nAutoOW > maxChgbl) {\n                price = 0;\n              } else {\n                price = tmp[rsv.category][rsv.resType];\n              }\n            } else {\n              price = tmp[rsv.category][rsv.resType];\n              if (rsv.resType === \"course\") {\n                price *= rsv.numStudents;\n              }\n            }\n            updates.push({ id: rsv.id, price });\n          }\n        }\n      }\n      if (updates.length > 0) {\n        await xata.db.Reservations.update(updates);\n      }\n    }\n    return new Response(\"prices updated\", { status: 200 });\n  } catch (error) {\n    console.log(error);\n    return new Response(error, { status: 500 });\n  }\n}\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}