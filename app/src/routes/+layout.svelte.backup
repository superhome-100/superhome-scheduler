<script lang="ts">
  import '../styles/theme.css';
  import '../app.css';
  import '../styles/tailwind-utilities.css';
  import Sidebar from '../lib/components/Sidebar/Sidebar.svelte';
  import { authStore, auth } from '../lib/stores/auth';
  import { onMount } from 'svelte';
  import { getUserInfo, sidebarActions, mobileDrawerOpen } from '../lib/stores/sidebar';
  import { page } from '$app/stores';

  let isAdmin = false;
  let checked = false;
  let signingOut = false;

  // Use reactive authStore for user info
  $: ({ userEmail, userName, userAvatarUrl, userInitial } = getUserInfo($authStore));

  onMount(async () => {
    // Wait for auth to be determined
    if ($authStore.loading) return;

    // If unauthenticated, simply mark as checked and allow public routes to render
    if (!$authStore.user) {
      checked = true;
      return;
    }

    // Authenticated: check admin status
    try {
      isAdmin = await auth.isAdmin();
      checked = true;
    } catch (error) {
      console.error('Error checking admin status:', error);
      checked = true;
    }
  });

  // Define public routes where unauthenticated users should see the slot (e.g., login page)
  $: currentPath = $page.url.pathname;
  $: isPublicRoute = currentPath === '/' || currentPath === '/login' || currentPath === '/signup' || currentPath === '/auth/callback';

  // If we land on the callback route and are already authenticated, ensure we navigate to home
  $: if ($page.url.pathname === '/auth/callback' && $authStore.user) {
    if (typeof window !== 'undefined') window.location.replace('/');
  }

  async function handleSignOut() {
    if (signingOut) return;
    signingOut = true;
    await auth.signOut();
    // Redirect is now handled by auth.signOut()
  }

  // Check if current route needs sidebar
  $: needsSidebar = $page.url.pathname !== '/login' && $page.url.pathname !== '/signup' && $page.url.pathname !== '/auth/callback';
</script>

{#if checked}
  {#if $authStore.user}
  {#if needsSidebar}
    <div class="min-h-screen bg-base-200">
      <div class="drawer lg:drawer-open">
        <!-- Checkbox input to control drawer state -->
        <input id="mobile-drawer" type="checkbox" class="drawer-toggle" bind:checked={$mobileDrawerOpen} />
        
        <!-- Main content area -->
        <div class="drawer-content flex flex-col">
          <!-- Mobile hamburger menu button -->
          <div class="lg:hidden navbar bg-base-100">
            <div class="flex-none">
              <label for="mobile-drawer" class="btn btn-square btn-ghost" aria-label="Open sidebar menu">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
              </label>
            </div>
            <div class="flex-1">
              <a class="btn btn-ghost text-xl" href="/">SuperHome</a>
            </div>
          </div>
          
          <!-- Page content -->
          <main class="flex-1 p-4 sm:p-6 lg:p-8">
            <div class="max-w-7xl w-full mx-auto">
              <slot />
            </div>
          </main>
        </div>

        <!-- Sidebar for desktop and mobile drawer -->
        <Sidebar {isAdmin} {userName} {userEmail} {userAvatarUrl} {userInitial} on:signOut={handleSignOut} />
      </div>
    </div>
    {:else}
      <!-- No sidebar for login/signup pages -->
      <slot />
    {/if}
  {:else}
    {#if isPublicRoute}
      <!-- Allow public routes to render their content (e.g., login page) -->
      <slot />
    {:else}
      <div class="min-h-screen flex items-center justify-center">
        <div class="alert alert-warning max-w-md">
          <span>Please log in to access the application.</span>
          <a class="link link-primary" href="/">Go to login</a>
        </div>
      </div>
    {/if}
  {/if}
{:else}
  <div class="min-h-screen flex items-center justify-center">
    <span class="loading loading-spinner loading-lg" aria-label="Loading..."></span>
  </div>
{/if}